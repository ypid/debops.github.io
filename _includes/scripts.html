<script>
(function() {

  function getJSON(url, successHandler, errorHandler) {
    var xhr = new XMLHttpRequest();
    xhr.open('get', url, true);
    xhr.responseType = 'json';
    xhr.onload = function() {
      var status = xhr.status;
      if (status == 200) {
        successHandler && successHandler(xhr.response);
      } else {
        errorHandler && errorHandler(status);
      }
    };
    xhr.send();
  };

  function github_repo(metadata, role_full_name) {
    return '<a href="' + metadata.vcs_url + '" title="View it on Github">' + role_full_name + '</a>';
  }

  function travis_badge(metadata, role_full_name) {
    return '<a style="float: left;" href="' + metadata.ci_url + '"><img src="' + metadata.ci_badge_url + '" alt="Build status" /></a>';
  }

  function testsuite_link(metadata, role_full_name) {
    return '<a style="float: right; font-size: 0.7rem;" href="' + metadata.test_suite_url + '">[view tests]</a>';
  }

  function role_format_version(metadata, role_full_name) {
    return '<span style="float: right; font-size: 0.7rem;">[Standards: v' + metadata.role_format_version + ']</span>';
  }

  function role_version(metadata, role_full_name) {
    if (metadata.hasOwnProperty('changelog_url')) {
      var elem = document.createElement('a');
      elem.setAttribute('href', metadata.changelog_url);
    } else {
      var elem = document.createElement('span');
    }
    elem.setAttribute('style', 'float: right; font-size: 0.7rem;');

    var version = 'unknown';
    if (metadata.hasOwnProperty('version')) {
      version = 'v' + metadata.version;
    }
    if (version === 'unknown') {
      elem.setAttribute('title', 'Unknown because currently not provided by the DebOps API (reason: Standards Version too old).');
    }

    elem.innerHTML = '[Release: ' + version + ']';
    return elem;
  }

  function min_ansible_version(metadata, role_full_name) {
    return '<span style="float: right; font-size: 0.7rem;">[Min. Ansible : v' + metadata.min_ansible_version + ']</span>';
  }

  function build_status() {
    var tbody = document.getElementById('status').getElementsByTagName('tbody')[0];
    var role_count = 0;

    getJSON('https://api.debops.org/v0/roles/debops.json', function(data) {
      for (var key in data) {
        if (data.hasOwnProperty(key)) {
          role_count++;

          var row = tbody.insertRow(tbody.rows.length);

          row.insertCell(0).insertAdjacentHTML('beforeend',
            github_repo(data[key], key)
            // + ' ' + role_format_version(data[key], key)
            // + ' ' + role_version_and_format(data[key], key)
          );
          row.insertCell(1).insertAdjacentHTML('beforeend',
            travis_badge(data[key], key)
          );
          row.insertCell(2).insertAdjacentHTML('beforeend',
            testsuite_link(data[key], key)
          );
          row.insertCell(3).appendChild(
            role_version(data[key], key)
          );
          row.insertCell(4).insertAdjacentHTML('beforeend',
            role_format_version(data[key], key)
          );

          var tds = document.getElementsByTagName('td');
          tds[1].style.width = '4rem';
          tds[2].style.width = '4.2rem';
          tds[3].style.width = '7rem';
          tds[4].style.width = '7rem';
        }
      }
      document.getElementById('role_count').innerHTML = role_count;
    });
  }

  function update_role_count() {
    var xhr = new XMLHttpRequest();
    xhr.open('get', 'https://api.debops.org/v0/roles/count:debops', true);
    xhr.onload = function() {
      var status = xhr.status;
      if (status == 200) {
        document.getElementById('role_count').innerHTML = xhr.response;
      }
    };
    xhr.send();
  }

  if (document.getElementById('status')) {
    build_status();
  } else if (document.getElementById('role_count')) {
    update_role_count();
  }

})();
</script>
